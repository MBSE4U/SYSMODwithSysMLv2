<!DOCTYPE html>
<html lang="en">

<!--
Copyright 2025 Tim Weilkiens

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SysML v2 API - SYSMOD Demonstrator</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            blue: '#4f46e5', // Indigo 600
                            teal: '#06b6d4', // Cyan 500
                            dark: '#0f172a', // Slate 900
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(6, 182, 212, 0.3)',
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            /* Indigo 600 */
            --primary-hover: #4338ca;
            /* Indigo 700 */
            --background-color: #f3f4f6;
            /* Gray 100 */
            --surface-color: #ffffff;
            --text-color: #1f2937;
            /* Gray 800 */
            --text-secondary: #6b7280;
            /* Gray 500 */
            --border-color: #d1d5db;
            /* Gray 300 */
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .section {
            background-color: var(--surface-color);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: var(--font-family);
            color: var(--text-color);
            background-color: #fff;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            margin-bottom: 1rem;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-family: var(--font-family);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3), 0 2px 4px -1px rgba(79, 70, 229, 0.15);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4), 0 4px 6px -2px rgba(79, 70, 229, 0.2);
            filter: brightness(1.1);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px -1px rgba(79, 70, 229, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
            box-shadow: 0 4px 6px -1px rgba(75, 85, 99, 0.3), 0 2px 4px -1px rgba(75, 85, 99, 0.15) !important;
            color: white;
            /* Ensure text is white */
            font-weight: 600;
            padding: 12px 24px;
            /* Ensure padding matches */
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-family: var(--font-family);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            /* Prevent text wrapping */
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 15px -3px rgba(75, 85, 99, 0.4), 0 4px 6px -2px rgba(75, 85, 99, 0.2) !important;
        }

        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .result-display {
            font-weight: 600;
            color: var(--primary-color) !important;
            background-color: #eef2ff;
            padding: 12px;
            border-radius: var(--radius);
            border: 1px solid #c7d2fe;
            margin-top: 10px;
        }

        pre {
            background: #f9fafb;
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid #e5e7eb;
            overflow-x: auto;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }

        /* D3 Graph Styles */
        #graphical_tree {
            margin-top: 20px;
        }

        .node circle {
            fill: #fff;
            stroke: var(--primary-color);
            stroke-width: 2px;
        }

        .node text {
            font: 12px sans-serif;
            fill: var(--text-color);
        }

        .link {
            fill: none;
            stroke: #9ca3af;
            stroke-width: 1.5px;
        }

        /* Responsive adjustments */
        @media (min-width: 640px) {
            button {
                width: auto;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.2);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <!-- Top Navigation -->
    <nav
        class="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md border-b border-white/50 shadow-sm transition-all duration-300">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-3">
                    <img src="mbse4u_logo.png" alt="MBSE4U" class="h-10 mr-2">
                    <div class="bg-gradient-to-tr from-brand-blue to-brand-teal p-2 rounded-lg text-white shadow-glow">
                        <i data-lucide="box" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">SYSMOD<span
                            class="text-brand-blue">Demonstrator</span></span>
                </div>
                <!-- Breadcrumbs / Context -->
                <div
                    class="hidden md:flex items-center space-x-2 text-sm text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                    <span>Repository</span>
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    <span class="font-medium text-slate-700">Project Selection</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="alert('List of quality checks (Coming Soon)')"
                        class="p-2 text-slate-400 hover:text-brand-blue transition-colors">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                    </button>
                    <div onclick="alert('Authentification will be added later')"
                        class="cursor-pointer h-8 w-8 rounded-full bg-gradient-to-r from-slate-200 to-slate-300 border border-white shadow-sm overflow-hidden hover:ring-2 hover:ring-brand-blue transition-all">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Tim" alt="User" />
                    </div>
                </div>
            </div>
        </div>
    </nav>

    </nav>

    <!-- Fancy Loading Overlay -->
    <div id="loading_overlay" class="loading-overlay">
        <div class="spinner"></div>
        <h3 class="text-xl font-bold text-slate-800 tracking-tight">Fetching Projects</h3>
        <p class="text-slate-500 mt-2 animate-pulse">Connecting to SysML v2 Server...</p>
    </div>

    <div class="container pt-24">
        <!-- Replaced Title/Logo with Header -->
        <div class="section">
            <label for="server_url">SysML v2 Repository Server URL</label>
            <input type="text" id="server_url" placeholder="Enter server URL (e.g., http://example.com)" />
            <div class="mt-3 flex items-center gap-3">
                <button onclick="queryProjects()" class="btn-primary flex-1">Get Projects</button>
                <button onclick="toggleSettings()" class="btn-secondary shrink-0">⚙️ Params</button>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section" id="settings_section" style="display: none; border-color: #6b7280;">
            <h2>Settings</h2>

            <div style="margin-bottom: 1rem;">
                <label for="page_size">General Page Size</label>
                <input type="text" id="page_size" value="256" placeholder="Default: 256" onchange="saveSettings()" />
                <p style="font-size: 0.8rem; color: #6b7280;">Page size for general queries.</p>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="cache_page_size">Cache Loading Page Size</label>
                <input type="text" id="cache_page_size" value="512" placeholder="Default: 512"
                    onchange="saveSettings()" />
                <p style="font-size: 0.8rem; color: #6b7280;">Page size for loading elements into cache (heavier
                    payload).</p>
            </div>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="skip_cache_load" onchange="saveSettings()" />
                    <label for="skip_cache_load" style="margin-bottom: 0;">Skip Initial Cache Loading</label>
                </div>
                <p style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">If checked, skips the bulk cache warmup.
                    Elements will be cached on demand.</p>
            </div>
        </div>

        <!-- Projects Section -->
        <div class="section" id="projects_section" style="display: none;">
            <h2>Select Project</h2>
            <label for="project_list" id="project_list_label">Available Projects</label>
            <select id="project_list" onchange="storeSelectedProjectId()">
                <option value="">-- Select a Project --</option>
            </select>

            <div style="margin-top: 1.5rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem;">
                <label for="manual_project_id">Or manually enter Project ID</label>
                <input type="text" id="manual_project_id" placeholder="Enter Project ID manually"
                    oninput="storeManualProjectId()" />
            </div>

            <p id="selected_project_display" class="result-display" style="display: none;"></p>
        </div>

        <!-- Commits Section -->
        <div class="section" id="commits_section" style="display: none;">
            <h2>Select Commit</h2>
            <label for="commit_list">Available Commits</label>
            <select id="commit_list" onchange="storeSelectedCommitId()">
                <option value="">-- Select a Commit --</option>
            </select>
            <p id="commit_error_message"
                style="display: none; color: #dc2626; background-color: #fee2e2; border: 1px solid #fecaca; padding: 12px; border-radius: 8px; margin-top: 10px; font-weight: 600;">
            </p>
            <p id="selected_commit_display" class="result-display" style="display: none;"></p>
            <p id="selected_commit_display" class="result-display" style="display: none;"></p>
        </div>

        <!-- SYSMOD Projects Section -->
        <div class="section" id="sysmodProjects_section" style="display: none;">
            <h2>Select SYSMOD Project</h2>
            <label for="sysmod_project_list">Available SYSMOD Projects</label>
            <select id="sysmod_project_list" onchange="storeSelectedSYSMODProjectId()">
                <option value="">-- Select a SYSMOD Project --</option>
            </select>
            <p id="selected_sysmod_project_display" class="result-display" style="display: none;"></p>
        </div>
    </div>

    <script>
        // Load settings on startup
        window.onload = function () {
            const savedPageSize = localStorage.getItem('sysmod_page_size');
            if (savedPageSize) {
                document.getElementById('page_size').value = savedPageSize;
            }
            const savedCachePageSize = localStorage.getItem('sysmod_cache_page_size');
            if (savedCachePageSize) {
                document.getElementById('cache_page_size').value = savedCachePageSize;
            }
            const savedSkipCache = localStorage.getItem('sysmod_skip_cache_load');
            if (savedSkipCache === 'true') {
                document.getElementById('skip_cache_load').checked = true;
            }
        };

        function toggleSettings() {
            const section = document.getElementById('settings_section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function saveSettings() {
            const pageSize = document.getElementById('page_size').value;
            localStorage.setItem('sysmod_page_size', pageSize);

            const cachePageSize = document.getElementById('cache_page_size').value;
            localStorage.setItem('sysmod_cache_page_size', cachePageSize);

            const skipCache = document.getElementById('skip_cache_load').checked;
            localStorage.setItem('sysmod_skip_cache_load', skipCache);
        }

        async function queryProjects() {
            const serverUrl = document.getElementById('server_url').value;
            if (!serverUrl) {
                alert("Please enter a Server URL.");
                return;
            }
            const projectList = document.getElementById('project_list');
            const projectsSection = document.getElementById('projects_section');

            projectList.innerHTML = '<option value="">-- Select a Project --</option>';
            document.getElementById('project_list_label').textContent = 'Available Projects'; // Reset label

            // Clear previous selection
            document.getElementById('selected_project_display').textContent = '';
            document.getElementById('selected_project_display').style.display = 'none';
            document.getElementById('manual_project_id').value = '';

            projectsSection.style.display = 'none';
            document.getElementById('commits_section').style.display = 'none';
            document.getElementById('sysmodProjects_section').style.display = 'none';

            document.getElementById('sysmodProjects_section').style.display = 'none';

            // Show Overlay
            const overlay = document.getElementById('loading_overlay');
            overlay.style.display = 'flex';

            try {
                const pageSize = document.getElementById('page_size').value || "256";
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ server_url: serverUrl, page_size: pageSize })
                });

                if (response.ok) {
                    const projects = await response.json();
                    document.getElementById('project_list_label').textContent = `Available Projects (Found: ${projects.length})`;
                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project['@id'];
                        option.text = `${project.name || project['@id']} (Created: ${project.created}, ID: ${project['@id']})`;
                        projectList.appendChild(option);
                    });
                    projectsSection.style.display = 'block';
                } else {
                    alert('Failed to retrieve projects');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                // Hide Overlay
                overlay.style.display = 'none';
            }
        }

        function storeSelectedProjectId() {
            const projectId = document.getElementById('project_list').value;
            const display = document.getElementById('selected_project_display');
            display.textContent = `Selected Project ID: ${projectId}`;
            display.style.display = 'block';
            queryCommits();
        }

        function storeManualProjectId() {
            const projectId = document.getElementById('manual_project_id').value;
            const display = document.getElementById('selected_project_display');
            display.textContent = `Selected Project ID: ${projectId}`;
            display.style.display = projectId ? 'block' : 'none';
            if (projectId) queryCommits();
        }

        async function queryCommits() {
            const serverUrl = document.getElementById('server_url').value;
            const projectId = document.getElementById('project_list').value || document.getElementById('manual_project_id').value;
            const commitList = document.getElementById('commit_list');
            const commitsSection = document.getElementById('commits_section');
            const errorMessage = document.getElementById('commit_error_message');

            commitList.innerHTML = '<option value="">-- Select a Commit --</option>';
            errorMessage.style.display = 'none';
            commitsSection.style.display = 'none';

            // Clear previous commit selection
            document.getElementById('selected_commit_display').textContent = '';
            document.getElementById('selected_commit_display').style.display = 'none';
            document.getElementById('sysmodProjects_section').style.display = 'none';

            if (!projectId) return;

            try {
                const response = await fetch('/api/commits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ server_url: serverUrl, project_id: projectId })
                });

                if (response.ok) {
                    const commits = await response.json();

                    if (commits.length === 0) {
                        errorMessage.textContent = 'No commits found for this project.';
                        errorMessage.style.display = 'block';
                        commitsSection.style.display = 'block';
                    } else {
                        commits.forEach(commit => {
                            const option = document.createElement('option');
                            option.value = commit['@id'];
                            option.text = (commit.name || commit['@id']) + " / created: " + commit['created'];
                            commitList.appendChild(option);
                        });
                        commitsSection.style.display = 'block';
                    }
                } else {
                    errorMessage.textContent = 'Failed to retrieve commits. Server returned error.';
                    errorMessage.style.display = 'block';
                    commitsSection.style.display = 'block';
                }
            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.style.display = 'block';
                commitsSection.style.display = 'block';
            }
        }


        async function storeSelectedCommitId() {
            const commitId = document.getElementById('commit_list').value;
            const display = document.getElementById('selected_commit_display');
            display.textContent = `Selected Commit ID: ${commitId}`;
            display.style.display = 'block';

            document.getElementById('sysmodProjects_section').style.display = 'none';
            if (!commitId) return;

            // Show Loading Overlay
            const overlay = document.getElementById('loading_overlay');
            const overlayTitle = overlay.querySelector('h3');
            const overlayText = overlay.querySelector('p');

            overlay.style.display = 'flex';
            overlayTitle.textContent = "Processing Model";
            overlayText.textContent = "Initializing...";

            try {
                const skipCache = document.getElementById('skip_cache_load').checked;

                if (!skipCache) {
                    overlayText.textContent = "Warming up element cache (this may take a moment)...";
                    try {
                        const serverUrl = document.getElementById('server_url').value;
                        const projectId = document.getElementById('project_list').value || document.getElementById('manual_project_id').value;
                        const cachePageSize = document.getElementById('cache_page_size').value || "256";

                        const response = await fetch('/api/cache/warmup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ server_url: serverUrl, project_id: projectId, commit_id: commitId, page_size: cachePageSize })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log(`Cache warmed up: ${result.cached_elements} elements.`);
                        } else {
                            console.error("Failed to warm up cache");
                        }
                    } catch (e) {
                        console.error("Error warming up cache:", e);
                    }
                } else {
                    console.log("Skipping initial cache warmup as per settings.");
                }

                // Proceed to next step
                await querySYSMODProjects(overlay, overlayTitle, overlayText);

            } catch (error) {
                console.error(error);
                overlay.style.display = 'none'; // Ensure hidden on error if not handled inside
            }
        }

        async function querySYSMODProjects(overlay, overlayTitle, overlayText) {
            const serverUrl = document.getElementById('server_url').value;
            const projectId = document.getElementById('project_list').value || document.getElementById('manual_project_id').value;
            const commitId = document.getElementById('commit_list').value;
            const sysmodProjectsSection = document.getElementById('sysmodProjects_section');
            const projectList = document.getElementById('sysmod_project_list');

            if (!commitId) {
                if (overlay) overlay.style.display = 'none';
                return;
            }

            // Update Overlay Text if passed
            if (overlayTitle) overlayTitle.textContent = "Fetching SYSMOD Projects";
            if (overlayText) overlayText.textContent = "Searching for @project metadata...";

            // Ensure overlay is visible if called directly (though usually called from above)
            if (overlay && overlay.style.display === 'none') overlay.style.display = 'flex';

            try {
                const response = await fetch('/api/sysmod_projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ server_url: serverUrl, project_id: projectId, commit_id: commitId })
                });

                if (response.ok) {
                    const projects = await response.json();
                    projectList.innerHTML = '<option value="">-- Select a SYSMOD Project --</option>'; // Clear previous options
                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project['@id'];
                        option.text = (project.name || project['@id']);
                        projectList.appendChild(option);
                    });
                    sysmodProjectsSection.style.display = 'block';
                } else {
                    alert('Failed to retrieve SYSMOD projects');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                if (overlay) overlay.style.display = 'none';
            }
        }

        function storeSelectedSYSMODProjectId() {
            const serverUrl = document.getElementById('server_url').value;
            const projectId = document.getElementById('project_list').value || document.getElementById('manual_project_id').value;
            const commitId = document.getElementById('commit_list').value;
            const smProjectId = document.getElementById('sysmod_project_list').value;

            if (smProjectId) {
                // Construct URL parameters to pass context to the new page
                const params = new URLSearchParams({
                    server_url: serverUrl,
                    project_id: projectId,
                    commit_id: commitId,
                    sysmod_project_id: smProjectId
                });

                // Open project.html in the same tab (or new tab if preferred, but user said "open a new web page", usually implies navigation)
                // "open a new web page" could mean window.open or location.href. 
                // Given it's a "single-page web dashboard", navigation (location.href) feels more natural for a SPA feel, 
                // but let's stick to standard navigation.
                window.location.href = `project.html?${params.toString()}`;
            }
        }


        // Initialize Lucide Icons
        lucide.createIcons();
    </script>
</body>

</html>